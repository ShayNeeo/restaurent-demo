<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/">
  <title>Buy Coupon - Demo</title>
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <!--
    - google font link
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Forum&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>
  <header class="header" data-header>
    <div class="container">
      <a href="/" class="logo">
        <img src="./assets/images/logo.svg" width="160" height="50" alt="Demo - Home">
      </a>
    </div>
  </header>
  <main>
    <article>
      <section class="section" aria-label="coupon">
        <div class="container" style="max-width:640px;margin:0 auto;">
          <div class="special-dish-content bg-black-10" style="padding:40px;border-radius:12px">
            <div style="text-align:center;margin-bottom:30px">
              <h2 class="headline-1 section-title" style="color:var(--gold-crayola);margin-bottom:10px">Buy Gift Coupon</h2>
              <p class="section-text">Pay €50, receive €55 value (10% bonus). Choose any amount.</p>
            </div>
          <div class="grid-list" style="grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin: 16px 0;">
            <button class="btn btn-secondary" data-quick-amount="10"><span class="text text-1">€10</span><span class="text text-2" aria-hidden="true">€10</span></button>
            <button class="btn btn-secondary" data-quick-amount="20"><span class="text text-1">€20</span><span class="text text-2" aria-hidden="true">€20</span></button>
            <button class="btn btn-secondary" data-quick-amount="50"><span class="text text-1">€50</span><span class="text text-2" aria-hidden="true">€50</span></button>
            <button class="btn btn-secondary" data-quick-amount="100"><span class="text text-1">€100</span><span class="text text-2" aria-hidden="true">€100</span></button>
          </div>
          <div class="input-wrapper" style="margin-top:12px;">
            <input id="gift-amount" type="number" min="10" step="5" placeholder="Custom amount (min €10)" class="input-field" />
          </div>
            <button id="gift-buy" class="btn btn-primary" style="width:100%;margin-top:16px">
              <span class="text text-1">Buy Now</span>
              <span class="text text-2" aria-hidden="true">Buy Now</span>
            </button>
          </div>
        </div>
      </section>
    </article>
  </main>
  <script src="./assets/js/script.js"></script>
  <script src="./assets/js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Quick amount buttons
      document.querySelectorAll('[data-quick-amount]')?.forEach(function(b){
        b.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          var v = this.getAttribute('data-quick-amount');
          var input = document.getElementById('gift-amount');
          if (input) {
            input.value = v;
            input.dataset.selected = v; // Store value as backup
            input.focus();
            updateBuyButtonText();
            console.log('Quick amount selected:', v, 'input.value now:', input.value);
          }
        });
      });

      // Update button text when input changes
      function updateBuyButtonText() {
        var input = document.getElementById('gift-amount');
        var btn = document.getElementById('gift-buy');
        var amount = input && input.value ? parseFloat(input.value) : null;
        
        if (amount && amount >= 10) {
          var bonus = (amount * 0.10).toFixed(2);
          var total = (amount + parseFloat(bonus)).toFixed(2);
          btn.innerHTML = `<span class="text text-1">Buy €${amount} (Get €${total} total)</span><span class="text text-2" aria-hidden="true">Buy €${amount} (Get €${total} total)</span>`;
        } else {
          btn.innerHTML = `<span class="text text-1">Buy Now</span><span class="text text-2" aria-hidden="true">Buy Now</span>`;
        }
      }

      // Buy button click handler
      document.getElementById('gift-buy')?.addEventListener('click', async function(e){
        e.preventDefault();
        e.stopPropagation();
        
        var input = document.getElementById('gift-amount');
        var eur = null;
        
        // Try to get value from input
        if (input && input.value) {
          eur = parseFloat(input.value);
          console.log('Input value:', input.value, 'parsed as:', eur);
        } else if (input && input.dataset.selected) {
          // Fallback to data attribute
          eur = parseFloat(input.dataset.selected);
          console.log('Using dataset.selected:', eur);
        }
        
        console.log('Validation check - eur:', eur, 'isNaN:', isNaN(eur), 'eur < 10:', eur < 10);
        
        // Validate: must have a number >= 10
        if (eur === null || isNaN(eur) || eur < 10) {
          var currentVal = input ? (input.value || input.dataset.selected || '0') : '0';
          console.error('Validation failed! eur:', eur, 'currentVal:', currentVal);
          alert(`❌ Please enter a valid amount (minimum €10). Current value: €${currentVal}`);
          return; // STOP HERE - do not proceed
        }
        
        console.log('✅ Validation passed! Proceeding with purchase: €' + eur);
        
        // Check if logged in
        var token = localStorage.getItem('restaurant_jwt_v1');
        var email = localStorage.getItem('restaurant_email_v1');
        
        if (!token || !email) {
          console.log('Not logged in, showing auth modal');
          if (typeof showAuthModal === 'function') {
            localStorage.setItem('post_auth_action', 'buy_gift');
            localStorage.setItem('post_auth_gift_amount', String(eur));
            showAuthModal();
            return;
          }
        }
        
        console.log('Processing gift coupon purchase:', { amount_eur: eur, email });
        
        try {
          const response = await fetch('/api/gift-coupons/buy', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              ...(token ? { Authorization: `Bearer ${token}` } : {})
            },
            body: JSON.stringify({ amount_eur: eur, email })
          });
          
          const data = await response.json();
          console.log('API response:', data);
          
          if (data?.url) {
            console.log('Redirecting to PayPal:', data.url);
            window.location.href = data.url;
          } else {
            alert('Failed to create PayPal order. Please try again.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error: ' + error.message);
        }
      });

      // Listen to input changes
      document.getElementById('gift-amount')?.addEventListener('input', updateBuyButtonText);
      document.getElementById('gift-amount')?.addEventListener('change', updateBuyButtonText);

      // Initialize button text on page load
      updateBuyButtonText();
    });
  </script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>


