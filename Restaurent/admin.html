<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/">
  <title>Admin Dashboard - Demo</title>
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Forum&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./assets/css/style.css">
  <style>
    body { background: var(--eerie-black-3, #111827); }
    .admin-container { display: grid; grid-template-columns: 250px 1fr; gap: 0; min-height: 100vh; }
    .admin-sidebar { background: var(--smoky-black-2, #1f2937); border-right: 1px solid var(--white-alpha-10, #374151); padding: 20px; position: sticky; top: 0; max-height: 100vh; overflow-y: auto; }
    .admin-main { padding: 20px; overflow-y: auto; }
    .admin-header { background: var(--smoky-black-2, #1f2937); padding: 20px; border-bottom: 1px solid var(--white-alpha-10, #374151); margin: -20px -20px 20px -20px; }
    .sidebar-section { margin-bottom: 20px; }
    .sidebar-section h3 { color: var(--gold-crayola, #ffd700); font-size: 12px; font-weight: 700; text-transform: uppercase; margin: 0 0 12px; }
    .sidebar-btn { display: block; width: 100%; text-align: left; padding: 10px 12px; background: var(--eerie-black-2, #1f2937); border: 1px solid var(--white-alpha-10, #374151); color: var(--white); border-radius: 6px; cursor: pointer; margin-bottom: 6px; font-size: 13px; transition: all 0.2s; }
    .sidebar-btn:hover, .sidebar-btn.active { background: var(--gold-crayola, #ffd700); color: var(--smoky-black-1, #000); border-color: var(--gold-crayola, #ffd700); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--white); font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; background: var(--eerie-black-2, #1f2937); border: 1px solid var(--white-alpha-10, #374151); color: var(--white); border-radius: 6px; font-size: 13px; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold-crayola, #ffd700); box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.1); }
    .data-table { width: 100%; border-collapse: collapse; background: var(--smoky-black-2, #1f2937); border-radius: 8px; overflow: hidden; border: 1px solid var(--white-alpha-10, #374151); }
    .data-table thead { background: var(--eerie-black-3, #111827); }
    .data-table th { padding: 12px; text-align: left; font-weight: 700; color: var(--gold-crayola, #ffd700); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--white-alpha-10, #374151); }
    .data-table td { padding: 12px; border-bottom: 1px solid var(--white-alpha-20, #1f2937); color: var(--white); font-size: 13px; word-break: break-all; }
    .data-table tr:hover { background: var(--eerie-black-2, #1f2937); }
    .btn-small { padding: 6px 12px; font-size: 11px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-delete { background: #dc2626; color: white; }
    .btn-delete:hover { background: #b91c1c; }
    .btn-edit { background: var(--gold-crayola, #ffd700); color: var(--smoky-black-1, #000); }
    .btn-edit:hover { background: #ffed4e; }
    .btn-action { background: #10b981; color: white; }
    .btn-action:hover { background: #059669; }
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .status-success { background: #10b98122; color: #10b981; }
    .status-error { background: #dc262622; color: #dc2626; }
    .status-warning { background: #f5951722; color: #f59517; }
    .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: var(--smoky-black-2, #1f2937); border: 1px solid var(--white-alpha-10, #374151); border-radius: 8px; padding: 16px; }
    .loading { text-align: center; padding: 20px; color: var(--quick-silver, #9ca3af); }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--gold-crayola, #ffd700); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--quick-silver, #9ca3af); }
    .pagination { display: flex; gap: 8px; margin-top: 16px; justify-content: center; align-items: center; }
    .pagination button, .pagination input { padding: 6px 12px; background: var(--eerie-black-2, #1f2937); border: 1px solid var(--white-alpha-10, #374151); color: var(--white); border-radius: 4px; cursor: pointer; }
    .pagination button:hover { background: var(--gold-crayola, #ffd700); color: var(--smoky-black-1, #000); }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div style="margin-bottom: 20px; text-align: center;">
        <img src="./assets/images/logo.svg" width="140" height="44" alt="Logo" style="margin-bottom: 16px;">
        <div style="font-weight: 700; color: var(--gold-crayola); margin-bottom: 6px;">Admin Panel</div>
        <div id="admin-user-email" style="font-size: 12px; color: var(--quick-silver); word-break: break-all;"></div>
      </div>

      <div class="sidebar-section">
        <h3>Dashboard</h3>
        <button class="sidebar-btn active" data-tab="overview">üìä Overview</button>
        <button class="sidebar-btn" data-tab="orders">üì¶ Orders</button>
        <button class="sidebar-btn" data-tab="users">üë• Users</button>
        <button class="sidebar-btn" data-tab="coupons">üéüÔ∏è Coupons</button>
        <button class="sidebar-btn" data-tab="products">üçΩÔ∏è Products</button>
        <button class="sidebar-btn" data-tab="pending">‚è≥ Pending Orders</button>
        <button class="sidebar-btn" data-tab="giftcodes">üéÅ Gift Codes</button>
      </div>

      <div class="sidebar-section">
        <h3>System</h3>
        <button class="sidebar-btn" data-tab="health">üè• Health Check</button>
        <button class="sidebar-btn" onclick="window.location.href='/test-email'">‚úâÔ∏è Test Email</button>
        <button class="sidebar-btn" onclick="window.location.href='/test-paypal'">üí≥ Test PayPal</button>
      </div>

      <div class="sidebar-section">
        <h3>Account</h3>
        <button class="sidebar-btn" data-tab="settings">‚öôÔ∏è Settings</button>
        <button class="sidebar-btn" onclick="if(confirm('Sign out?')) { localStorage.removeItem('restaurant_jwt_v1'); localStorage.removeItem('restaurant_email_v1'); location.href='/'; }">üö™ Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1 class="headline-2" style="color: var(--gold-crayola); margin: 0;">Database Management</h1>
        <p style="color: var(--quick-silver); margin: 4px 0 0; font-size: 14px;">Manage all restaurant data and system settings</p>
      </div>

      <!-- Overview Tab -->
      <div id="overview" class="tab-content active">
        <div class="grid-2col" style="margin-bottom: 20px;">
          <div class="card">
            <div style="font-size: 12px; color: var(--quick-silver); margin-bottom: 8px;">TOTAL ORDERS</div>
            <div id="stat-orders" style="font-size: 32px; font-weight: 700; color: var(--gold-crayola);">-</div>
          </div>
          <div class="card">
            <div style="font-size: 12px; color: var(--quick-silver); margin-bottom: 8px;">REGISTERED USERS</div>
            <div id="stat-users" style="font-size: 32px; font-weight: 700; color: var(--gold-crayola);">-</div>
          </div>
          <div class="card">
            <div style="font-size: 12px; color: var(--quick-silver); margin-bottom: 8px;">ACTIVE COUPONS</div>
            <div id="stat-coupons" style="font-size: 32px; font-weight: 700; color: var(--gold-crayola);">-</div>
          </div>
          <div class="card">
            <div style="font-size: 12px; color: var(--quick-silver); margin-bottom: 8px;">PENDING ORDERS</div>
            <div id="stat-pending" style="font-size: 32px; font-weight: 700; color: #f59517;">-</div>
          </div>
        </div>
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">Recent Orders</h3>
          <div id="overview-recent" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Orders Tab -->
      <div id="orders" class="tab-content">
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">All Orders</h3>
          <div class="form-group">
            <label>Filter by Email:</label>
            <input type="text" id="orders-filter" placeholder="Search email..." />
          </div>
          <div id="orders-list" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="tab-content">
        <div class="grid-2col" style="margin-bottom: 20px;">
          <div class="card">
            <h3 style="color: var(--gold-crayola); margin: 0 0 12px;">Add/Update User</h3>
            <div class="form-group">
              <label>Email:</label>
              <input type="email" id="user-email" placeholder="user@example.com" />
            </div>
            <div class="form-group">
              <label>Role:</label>
              <select id="user-role">
                <option value="customer">Customer</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="updateUserRole()" style="width: 100%;">
              <span class="text text-1">Update Role</span>
              <span class="text text-2" aria-hidden="true">Update Role</span>
            </button>
          </div>
          <div class="card">
            <h3 style="color: var(--gold-crayola); margin: 0 0 12px;">Delete User</h3>
            <div class="form-group">
              <label>Email to Delete:</label>
              <input type="email" id="user-delete-email" placeholder="user@example.com" />
            </div>
            <button class="btn-small btn-delete" onclick="deleteUser()" style="width: 100%;">Delete User</button>
          </div>
        </div>
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">All Users</h3>
          <div id="users-list" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Coupons Tab -->
      <div id="coupons" class="tab-content">
        <div class="grid-2col" style="margin-bottom: 20px;">
          <div class="card">
            <h3 style="color: var(--gold-crayola); margin: 0 0 12px;">Create Coupon</h3>
            <div class="form-group">
              <label>Code:</label>
              <input type="text" id="coupon-code" placeholder="SAVE10" />
            </div>
            <div class="form-group">
              <label>Percent Off (%):</label>
              <input type="number" id="coupon-percent" placeholder="10" min="0" max="100" />
            </div>
            <div class="form-group">
              <label>Amount Off (cents):</label>
              <input type="number" id="coupon-amount" placeholder="500" min="0" />
            </div>
            <div class="form-group">
              <label>Remaining Uses:</label>
              <input type="number" id="coupon-uses" placeholder="100" min="0" />
            </div>
            <button class="btn-small btn-action" onclick="createCoupon()" style="width: 100%;">Create Coupon</button>
    </div>
          <div class="card">
            <h3 style="color: var(--gold-crayola); margin: 0 0 12px;">Manage Gift Codes</h3>
            <div class="form-group">
              <label>Search Gift Code:</label>
              <input type="text" id="giftcode-search" placeholder="GIFT-xxx" />
            </div>
            <button class="btn-small btn-edit" onclick="searchGiftCode()" style="width: 100%; margin-bottom: 10px;">Search</button>
            <div id="giftcode-result" style="font-size: 12px; color: var(--quick-silver);"></div>
          </div>
        </div>
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">All Coupons</h3>
          <div id="coupons-list" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Products Tab -->
      <div id="products" class="tab-content">
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">All Products</h3>
          <div id="products-list" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Pending Orders Tab -->
      <div id="pending" class="tab-content">
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">Pending Orders (Awaiting Payment)</h3>
          <div id="pending-list" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Gift Codes Tab -->
      <div id="giftcodes" class="tab-content">
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">Gift Codes (Generated from /coupon)</h3>
          <div id="giftcodes-list" class="loading"><div class="spinner"></div> Loading...</div>
        </div>
      </div>

      <!-- Health Tab -->
      <div id="health" class="tab-content">
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">System Health</h3>
          <button class="btn-small btn-action" onclick="checkHealth()" style="margin-bottom: 16px;">Check Health Status</button>
          <div id="health-result" style="background: var(--eerie-black-2); padding: 12px; border-radius: 6px; border: 1px solid var(--white-alpha-10); white-space: pre-wrap; font-family: monospace; font-size: 12px; color: var(--white); display: none;"></div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings" class="tab-content">
        <div class="card">
          <h3 style="color: var(--gold-crayola); margin: 0 0 16px;">Admin Settings</h3>
          <div class="form-group">
            <label>Current Email:</label>
            <input type="email" id="settings-email" disabled />
          </div>
          <div class="form-group">
            <label>New Password:</label>
            <input type="password" id="settings-password" placeholder="Enter new password" />
          </div>
          <button class="btn-small btn-action" onclick="resetPassword()" style="width: 100%;">Update Password</button>
        </div>
      </div>
  </main>
  </div>

  <script src="./assets/js/script.js"></script>
  <script src="./assets/js/app.js"></script>
  <script>
    // Admin panel functionality
    const API_BASE = '/api';
    const token = localStorage.getItem('restaurant_jwt_v1');
    const email = localStorage.getItem('restaurant_email_v1');

    // Tab switching
    document.querySelectorAll('.sidebar-btn[data-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab)?.classList.add('active');
        btn.classList.add('active');
        
        // Load data for tab
        if (tab === 'overview') loadOverview();
        if (tab === 'orders') loadOrders();
        if (tab === 'users') loadUsers();
        if (tab === 'coupons') loadCoupons();
        if (tab === 'products') loadProducts();
        if (tab === 'pending') loadPendingOrders();
        if (tab === 'giftcodes') loadGiftCodes();
      });
    });

    document.getElementById('admin-user-email').textContent = email || 'Admin User';

    async function apiCall(method, path, body = null) {
      const options = {
        method,
        headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) }
      };
      if (body) options.body = JSON.stringify(body);
      const res = await fetch(`${API_BASE}${path}`, options);
      if (res.status === 401) { alert('Unauthorized'); location.href = '/'; return null; }
      if (!res.ok) {
        console.error(`API Error: ${res.status} ${res.statusText} for ${path}`);
        return null;
      }
      try { 
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return await res.json();
        } else {
          return await res.text();
        }
      } catch (e) {
        console.error('Failed to parse response:', e);
        return null;
      }
    }

    async function loadOverview() {
      const orders = await apiCall('GET', '/admin/query?table=orders&limit=10');
      const users = await apiCall('GET', '/admin/query?table=users&limit=100');
      const coupons = await apiCall('GET', '/admin/query?table=coupons&limit=100');
      const pending = await apiCall('GET', '/admin/query?table=pending_orders&limit=100');

      document.getElementById('stat-orders').textContent = Array.isArray(orders) ? orders.length + '+' : '0';
      document.getElementById('stat-users').textContent = Array.isArray(users) ? users.length : '0';
      document.getElementById('stat-coupons').textContent = Array.isArray(coupons) ? coupons.filter(c => c.remaining_uses > 0).length : '0';
      document.getElementById('stat-pending').textContent = Array.isArray(pending) ? pending.length : '0';

      const recent = Array.isArray(orders) && orders.length > 0 ? orders.slice(0, 5).map(o => `<tr><td>${o.id?.substring(0, 8) || 'N/A'}...</td><td>${o.email || 'N/A'}</td><td>‚Ç¨${(o.total_cents / 100).toFixed(2)}</td></tr>`).join('') : '<tr><td colspan="3" style="text-align: center; color: var(--quick-silver);">No orders yet</td></tr>';
      document.getElementById('overview-recent').innerHTML = `<table class="data-table"><thead><tr><th>Order ID</th><th>Email</th><th>Total</th></tr></thead><tbody>${recent}</tbody></table>`;
    }

    async function loadOrders() {
      const orders = await apiCall('GET', '/admin/query?table=orders&limit=50');
      if (!Array.isArray(orders) || orders.length === 0) {
        document.getElementById('orders-list').innerHTML = '<div class="empty-state">No orders found</div>';
        return;
      }
      let html = `<table class="data-table"><thead><tr><th>Order ID</th><th>Email</th><th>Total</th><th>Coupon</th><th>Created</th></tr></thead><tbody>`;
      orders.forEach(o => {
        html += `<tr><td>${o.id?.substring(0, 12) || 'N/A'}...</td><td>${o.email || 'N/A'}</td><td>‚Ç¨${(o.total_cents / 100).toFixed(2)}</td><td>${o.coupon_code || '-'}</td><td>${new Date(o.created_at).toLocaleDateString()}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('orders-list').innerHTML = html;
    }

    async function loadUsers() {
      const users = await apiCall('GET', '/admin/query?table=users&limit=100');
      if (!Array.isArray(users) || users.length === 0) {
        document.getElementById('users-list').innerHTML = '<div class="empty-state">No users found</div>';
        return;
      }
      let html = `<table class="data-table"><thead><tr><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead><tbody>`;
      users.forEach(u => {
        html += `<tr><td>${u.email || 'N/A'}</td><td><span class="status-badge status-${u.role === 'admin' ? 'warning' : 'success'}">${u.role || 'customer'}</span></td><td>${new Date(u.created_at).toLocaleDateString()}</td><td><button class="btn-small btn-delete" onclick="if(confirm('Delete?')) { deleteUserByEmail('${u.email}'); }">Delete</button></td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('users-list').innerHTML = html;
    }

    async function loadCoupons() {
      const coupons = await apiCall('GET', '/admin/query?table=coupons&limit=100');
      if (!Array.isArray(coupons) || coupons.length === 0) {
        document.getElementById('coupons-list').innerHTML = '<div class="empty-state">No coupons found. <a href="#" onclick="document.querySelector(\'[data-tab=coupons]\').scrollIntoView(); return false;">Create one</a></div>';
        return;
      }
      let html = `<table class="data-table"><thead><tr><th>Code</th><th>Discount</th><th>Remaining Uses</th><th>Actions</th></tr></thead><tbody>`;
      coupons.forEach(c => {
        let discount = '';
        if (c.amount_off) discount = `‚Ç¨${(c.amount_off / 100).toFixed(2)}`;
        if (c.percent_off) discount = `${c.percent_off}%`;
        html += `<tr><td><strong>${c.code}</strong></td><td>${discount}</td><td><span class="status-badge ${c.remaining_uses > 0 ? 'status-success' : 'status-error'}">${c.remaining_uses || 0}</span></td><td><button class="btn-small btn-delete" onclick="if(confirm('Delete?')) { deleteCoupon('${c.code}'); }">Delete</button></td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('coupons-list').innerHTML = html;
    }

    async function loadProducts() {
      const products = await apiCall('GET', '/products');
      if (!products?.products || products.products.length === 0) {
        document.getElementById('products-list').innerHTML = '<div class="empty-state">No products found</div>';
        return;
      }
      let html = `<table class="data-table"><thead><tr><th>Name</th><th>Price</th><th>Currency</th></tr></thead><tbody>`;
      products.products.forEach(p => {
        html += `<tr><td>${p.name}</td><td>‚Ç¨${(p.unit_amount / 100).toFixed(2)}</td><td>${p.currency}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('products-list').innerHTML = html;
    }

    async function loadPendingOrders() {
      const pending = await apiCall('GET', '/admin/query?table=pending_orders&limit=100');
      if (!Array.isArray(pending) || pending.length === 0) {
        document.getElementById('pending-list').innerHTML = '<div class="empty-state">No pending orders</div>';
        return;
      }
      let html = `<table class="data-table"><thead><tr><th>PayPal Order ID</th><th>Email</th><th>Amount</th><th>Created</th><th>Action</th></tr></thead><tbody>`;
      pending.forEach(p => {
        html += `<tr><td>${p.order_id?.substring(0, 12) || 'N/A'}...</td><td>${p.email || 'N/A'}</td><td>‚Ç¨${(p.amount_cents / 100).toFixed(2)}</td><td>${new Date(p.created_at).toLocaleDateString()}</td><td><button class="btn-small btn-delete" onclick="deletePendingOrder('${p.order_id}')">Delete</button></td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('pending-list').innerHTML = html;
    }

    async function loadGiftCodes() {
      const giftCodes = await apiCall('GET', '/admin/query?table=gift_codes&limit=100');
      if (!Array.isArray(giftCodes) || giftCodes.length === 0) {
        document.getElementById('giftcodes-list').innerHTML = '<div class="empty-state">No gift codes found</div>';
        return;
      }
      let html = `<table class="data-table"><thead><tr><th>Code</th><th>Value</th><th>Remaining</th><th>Purchased By</th><th>Created</th></tr></thead><tbody>`;
      giftCodes.forEach(g => {
        const used = g.value_cents - g.remaining_cents;
        html += `<tr><td><strong>${g.code?.substring(0, 16)}</strong>...</td><td>‚Ç¨${(g.value_cents / 100).toFixed(2)}</td><td>‚Ç¨${(g.remaining_cents / 100).toFixed(2)}</td><td>${g.purchaser_email || '-'}</td><td>${new Date(g.created_at).toLocaleDateString()}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('giftcodes-list').innerHTML = html;
    }

    async function createCoupon() {
      const code = document.getElementById('coupon-code').value.trim().toUpperCase();
      const percent = Number(document.getElementById('coupon-percent').value || 0);
      const amount = Number(document.getElementById('coupon-amount').value || 0);
      const uses = Number(document.getElementById('coupon-uses').value || 0);
      if (!code) return alert('Please enter a coupon code');
      const res = await apiCall('POST', '/admin/coupons', { code, percent_off: percent || undefined, amount_off: amount || undefined, remaining_uses: uses });
      if (res) { alert('Coupon created!'); document.getElementById('coupon-code').value = ''; document.getElementById('coupon-percent').value = ''; document.getElementById('coupon-amount').value = ''; document.getElementById('coupon-uses').value = ''; loadCoupons(); }
    }

    async function deleteCoupon(code) {
      const res = await apiCall('DELETE', `/admin/coupons/${encodeURIComponent(code)}`);
      if (res) { alert('Coupon deleted!'); loadCoupons(); }
    }

    async function updateUserRole() {
      const email = document.getElementById('user-email').value.trim();
      const role = document.getElementById('user-role').value;
      if (!email) return alert('Please enter an email');
      const res = await apiCall('PATCH', `/admin/users/${encodeURIComponent(email)}`, { role });
      if (res) { alert('User role updated!'); loadUsers(); }
    }

    async function deleteUser() {
      const email = document.getElementById('user-delete-email').value.trim();
      if (!email) return alert('Please enter an email');
      if (!confirm('Are you sure?')) return;
      const res = await apiCall('POST', '/admin/delete', { table: 'users', key: 'email', value: email });
      if (res) { alert('User deleted!'); document.getElementById('user-delete-email').value = ''; loadUsers(); }
    }

    async function deleteUserByEmail(e) {
      const res = await apiCall('POST', '/admin/delete', { table: 'users', key: 'email', value: e });
      if (res) { alert('User deleted!'); loadUsers(); }
    }

    async function searchGiftCode() {
      const code = document.getElementById('giftcode-search').value.trim();
      if (!code) return alert('Please enter a gift code');
      const result = document.getElementById('giftcode-result');
      result.textContent = 'Searching...';
      const giftcodes = await apiCall('GET', '/admin/query?table=gift_codes&limit=1000');
      if (Array.isArray(giftcodes)) {
        const found = giftcodes.find(g => g.code === code);
        if (found) {
          result.innerHTML = `<strong>${found.code}</strong><br>Value: ‚Ç¨${(found.value_cents / 100).toFixed(2)}<br>Remaining: ‚Ç¨${(found.remaining_cents / 100).toFixed(2)}<br>Purchased: ${new Date(found.created_at).toLocaleDateString()}`;
        } else {
          result.textContent = 'Gift code not found';
        }
      }
    }

    async function checkHealth() {
      const result = document.getElementById('health-result');
      result.style.display = 'block';
      result.textContent = 'Checking...';
      const res = await apiCall('GET', '/health/detailed');
      result.textContent = JSON.stringify(res, null, 2);
    }

    async function resetPassword() {
      const pwd = document.getElementById('settings-password').value;
      if (!pwd) return alert('Please enter a password');
      const res = await apiCall('POST', '/auth/reset-password', { email, new_password: pwd });
      if (res?.token) { alert('Password updated! Logging you out...'); localStorage.removeItem('restaurant_jwt_v1'); location.href = '/'; }
    }

    async function deletePendingOrder(orderId) {
      if (!confirm('Delete this pending order?')) return;
      const res = await apiCall('POST', '/admin/delete', { table: 'pending_orders', key: 'order_id', value: orderId });
      if (res) { alert('Pending order deleted!'); loadPendingOrders(); }
    }

    // Load overview on page load
    loadOverview();
    document.getElementById('settings-email').value = email || '';
  </script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>


