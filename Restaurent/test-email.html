<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/">
  <title>Test Email - Demo</title>
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <!--
    - google font link
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Forum&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>
  <header class="header" data-header>
    <div class="container">
      <a href="/" class="logo">
        <img src="./assets/images/logo.svg" width="160" height="50" alt="Demo - Home">
      </a>
    </div>
  </header>

  <main>
    <article>
      <section class="section" aria-label="test-email">
        <div class="container" style="max-width:640px;margin:0 auto;">
          <div class="special-dish-content bg-black-10" style="padding:40px;border-radius:12px">
            <div style="text-align:center;margin-bottom:30px">
              <h2 class="headline-1 section-title" style="color:var(--gold-crayola);margin-bottom:10px">Test Email</h2>
              <p class="section-text">Test Brevo SMTP email sending functionality</p>
            </div>

            <div class="input-wrapper" style="margin-bottom:16px;">
              <label for="test-email-to" style="display:block;margin-bottom:8px;color:var(--white);font-weight:600;">To Email:</label>
              <input id="test-email-to" type="email" placeholder="recipient@example.com" class="input-field" style="width:100%;padding:12px;border:1px solid var(--white-alpha-20);background:var(--eerie-black-2);color:var(--white);border-radius:8px;" />
            </div>

            <div class="input-wrapper" style="margin-bottom:16px;">
              <label for="test-email-subject" style="display:block;margin-bottom:8px;color:var(--white);font-weight:600;">Subject:</label>
              <input id="test-email-subject" type="text" placeholder="Test Email Subject" class="input-field" style="width:100%;padding:12px;border:1px solid var(--white-alpha-20);background:var(--eerie-black-2);color:var(--white);border-radius:8px;" />
            </div>

            <div class="input-wrapper" style="margin-bottom:16px;">
              <label for="test-email-body" style="display:block;margin-bottom:8px;color:var(--white);font-weight:600;">Message:</label>
              <textarea id="test-email-body" placeholder="Enter your test message here..." class="input-field" rows="6" style="width:100%;padding:12px;border:1px solid var(--white-alpha-20);background:var(--eerie-black-2);color:var(--white);border-radius:8px;resize:vertical;"></textarea>
            </div>

            <div style="text-align:center;">
              <button id="test-email-send" class="btn btn-primary" style="margin-right:12px;">
                <span class="text text-1">Send Test Email</span>
                <span class="text text-2" aria-hidden="true">Send Test Email</span>
              </button>
              <button id="check-status" class="btn btn-secondary" style="margin-right:12px;">
                <span class="text text-1">Check Status</span>
                <span class="text text-2" aria-hidden="true">Check Status</span>
              </button>
              <a href="/" class="btn btn-secondary">
                <span class="text text-1">Back to Home</span>
                <span class="text text-2" aria-hidden="true">Back to Home</span>
              </a>
            </div>

            <div id="test-email-result" style="margin-top:20px;padding:16px;border-radius:8px;display:none;"></div>

            <!-- Troubleshooting Help -->
            <div style="margin-top:30px;padding:20px;border:1px solid var(--white-alpha-20);border-radius:8px;background:var(--eerie-black-2);">
              <h3 style="margin:0 0 12px;color:var(--gold-crayola);">üîß Troubleshooting</h3>
              <div style="color:var(--quick-silver);font-size:14px;">
                <p><strong>If you see a 502 Bad Gateway error:</strong></p>
                <ul style="margin:8px 0;">
                  <li>Check that the backend server is running</li>
                  <li>Verify SMTP credentials in your environment variables</li>
                  <li>Check server logs for error messages</li>
                  <li>Ensure all required environment variables are set: SMTP_HOST, SMTP_USERNAME, SMTP_PASSWORD, SMTP_FROM</li>
                </ul>
                <p><strong>Common SMTP Issues:</strong></p>
                <ul style="margin:8px 0;">
                  <li>Authentication failed: Check username/password</li>
                  <li>Connection failed: Check host/port and firewall</li>
                  <li>TLS/SSL issues: Verify security settings</li>
                </ul>
                <p><strong>Test with these SMTP settings:</strong></p>
                <div style="background:var(--smoky-black-1);padding:8px;border-radius:4px;font-family:monospace;font-size:12px;">
                  SMTP_HOST=smtp-relay.brevo.com<br>
                  SMTP_PORT=587<br>
                  SMTP_USERNAME=your-brevo-username<br>
                  SMTP_PASSWORD=your-brevo-api-key<br>
                  SMTP_FROM=no-reply@yourdomain.com
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </article>
  </main>

  <script src="./assets/js/script.js"></script>
  <script src="./assets/js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const sendBtn = document.getElementById('test-email-send');
      const statusBtn = document.getElementById('check-status');
      const resultDiv = document.getElementById('test-email-result');

      statusBtn?.addEventListener('click', async function() {
        try {
          statusBtn.disabled = true;
          statusBtn.innerHTML = '<span class="text text-1">Checking...</span><span class="text text-2" aria-hidden="true">Checking...</span>';

          // Check backend health (detailed)
          const healthResponse = await fetch('/api/health/detailed');
          const healthData = await healthResponse.json();

          // Check SMTP configuration
          let smtpStatus = 'Not configured';
          let smtpDetails = '';

          try {
            // This will test if the backend is responding to API calls
            const response = await fetch('/api/test-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                to: 'test@example.com',
                subject: 'Status Check',
                body: 'This is a status check - you can ignore this email'
              })
            });

            if (response.status === 400) {
              // This is expected if validation fails
              const errorData = await response.json();
              if (errorData.message && errorData.message.includes('SMTP configuration')) {
                smtpStatus = 'Configuration incomplete';
                smtpDetails = errorData.message;
              }
            } else if (response.ok) {
              smtpStatus = 'Ready to send';
            } else {
              smtpStatus = 'Error: ' + response.status;
            }
          } catch (error) {
            if (error.message.includes('502') || error.message.includes('Bad Gateway')) {
              smtpStatus = 'Backend server error (502)';
              smtpDetails = 'The backend server is not responding properly. This may indicate SMTP configuration issues or server crash.';
            } else {
              smtpStatus = 'Backend not responding';
              smtpDetails = error.message;
            }
          }

          const statusInfo = `
            <div style="background:var(--smoky-black-2);padding:16px;border-radius:8px;border:1px solid var(--white-alpha-20);">
              <h4 style="margin:0 0 12px;color:var(--gold-crayola);">System Status</h4>
              <div style="margin-bottom:8px;"><strong>Overall Status:</strong> ${healthData?.ok ? '‚úÖ OK' : '‚ùå Issues Found'}</div>
              <div style="margin-bottom:8px;"><strong>Database Connected:</strong> ${healthData?.database?.connected ? '‚úÖ Yes' : '‚ùå No'}</div>
              <div style="margin-bottom:8px;"><strong>Admin User Exists:</strong> ${healthData?.database?.admin_user_exists ? '‚úÖ Yes' : '‚ùå No'}</div>
              <div style="margin-bottom:8px;"><strong>SMTP Configured:</strong> ${healthData?.config?.smtp_configured ? '‚úÖ Yes' : '‚ùå No'}</div>
              <div style="margin-bottom:8px;"><strong>SMTP Status:</strong> ${smtpStatus}</div>
              ${healthData?.database?.error ? `<div style="margin-bottom:8px;color:#ef4444;"><strong>Database Error:</strong> ${healthData.database.error}</div>` : ''}
              ${smtpDetails ? `<div style="margin-bottom:8px;"><strong>Details:</strong> ${smtpDetails}</div>` : ''}
              <div style="margin-bottom:8px;"><strong>Current Time:</strong> ${new Date().toLocaleString()}</div>
              <div style="margin-top:12px;padding:8px;background:var(--eerie-black-1);border-radius:4px;">
                <strong>üí° Next Steps:</strong><br>
                ${!healthData?.database?.admin_user_exists ?
                  '‚Ä¢ Create admin user: POST /api/auth/setup-admin with email/password<br>' : ''}
                ${!healthData?.config?.smtp_configured ?
                  '‚Ä¢ Configure SMTP in environment variables<br>' : ''}
                ${healthData?.database?.error ?
                  '‚Ä¢ Check database migrations and run them<br>' : ''}
              </div>
            </div>
          `;

          showResult(statusInfo, 'info');
        } catch (error) {
          showResult(`Status check failed: ${error.message}`, 'error');
        } finally {
          statusBtn.disabled = false;
          statusBtn.innerHTML = '<span class="text text-1">Check Status</span><span class="text text-2" aria-hidden="true">Check Status</span>';
        }
      });

      sendBtn?.addEventListener('click', async function() {
        const to = document.getElementById('test-email-to').value.trim();
        const subject = document.getElementById('test-email-subject').value.trim();
        const body = document.getElementById('test-email-body').value.trim();

        if (!to || !subject || !body) {
          showResult('Please fill in all fields', 'error');
          return;
        }

        if (!isValidEmail(to)) {
          showResult('Please enter a valid email address', 'error');
          return;
        }

        try {
          sendBtn.disabled = true;
          sendBtn.innerHTML = '<span class="text text-1">Sending...</span><span class="text text-2" aria-hidden="true">Sending...</span>';

          const response = await fetch('/api/test-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, subject, body })
          });

          if (response.ok) {
            showResult('Email sent successfully!', 'success');
            // Clear form
            document.getElementById('test-email-to').value = '';
            document.getElementById('test-email-subject').value = '';
            document.getElementById('test-email-body').value = '';
          } else {
            const error = await response.text();
            showResult(`Failed to send email: ${error}`, 'error');
          }
        } catch (error) {
          showResult(`Error: ${error.message}`, 'error');
        } finally {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<span class="text text-1">Send Test Email</span><span class="text text-2" aria-hidden="true">Send Test Email</span>';
        }
      });

      function showResult(message, type) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = type === 'success' ? 'var(--gold-crayola)' : '#ef4444';
        resultDiv.style.color = type === 'success' ? 'var(--smoky-black-1)' : 'white';
        resultDiv.textContent = message;

        setTimeout(() => {
          resultDiv.style.display = 'none';
        }, 5000);
      }

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
    });
  </script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>
