<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/">
  <title>Test PayPal - Demo</title>
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <!--
    - google font link
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Forum&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>
  <header class="header" data-header>
    <div class="container">
      <a href="/" class="logo">
        <img src="./assets/images/logo.svg" width="160" height="50" alt="Demo - Home">
      </a>
    </div>
  </header>

  <main>
    <article>
      <section class="section" aria-label="test-paypal">
        <div class="container" style="max-width:640px;margin:0 auto;">
          <div class="special-dish-content bg-black-10" style="padding:40px;border-radius:12px">
            <div style="text-align:center;margin-bottom:30px">
              <h2 class="headline-1 section-title" style="color:var(--gold-crayola);margin-bottom:10px">Test PayPal</h2>
              <p class="section-text">Test PayPal payment notifications and order processing</p>
            </div>

            <div style="background:var(--smoky-black-2);padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid var(--white-alpha-10)">
              <h3 style="margin:0 0 12px;font-size:18px;color:var(--gold-crayola)">Webhook Testing</h3>
              <p style="margin:0 0 16px;color:var(--quick-silver)">Simulate PayPal webhook notifications for testing order processing.</p>

              <div class="input-wrapper" style="margin-bottom:12px;">
                <label for="webhook-order-id" style="display:block;margin-bottom:8px;color:var(--white);font-weight:600;">Order ID:</label>
                <input id="webhook-order-id" type="text" placeholder="Enter PayPal order ID" class="input-field" style="width:100%;padding:12px;border:1px solid var(--white-alpha-20);background:var(--eerie-black-2);color:var(--white);border-radius:8px;" />
              </div>

              <div style="text-align:center;">
                <button id="simulate-webhook" class="btn btn-primary">
                  <span class="text text-1">Simulate Payment</span>
                  <span class="text text-2" aria-hidden="true">Simulate Payment</span>
                </button>
              </div>
            </div>

            <div style="background:var(--smoky-black-2);padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid var(--white-alpha-10)">
              <h3 style="margin:0 0 12px;font-size:18px;color:var(--gold-crayola)">Order Status Check</h3>
              <p style="margin:0 0 16px;color:var(--quick-silver)">Check the status of pending orders in the database.</p>

              <div style="text-align:center;">
                <button id="check-pending-orders" class="btn btn-secondary">
                  <span class="text text-1">Check Pending Orders</span>
                  <span class="text text-2" aria-hidden="true">Check Pending Orders</span>
                </button>
              </div>
            </div>

            <div id="test-results" style="background:var(--eerie-black-2);padding:16px;border-radius:8px;border:1px solid var(--white-alpha-10);display:none;">
              <h3 style="margin:0 0 12px;color:var(--gold-crayola)">Results</h3>
              <pre id="results-content" style="color:var(--white);font-size:14px;white-space:pre-wrap;word-wrap:break-word;overflow-x:auto;"></pre>
            </div>

            <div style="text-align:center;margin-top:20px">
              <a href="/" class="btn btn-primary">
                <span class="text text-1">Back to Home</span>
                <span class="text text-2" aria-hidden="true">Back to Home</span>
              </a>
            </div>
          </div>
        </div>
      </section>
    </article>
  </main>

  <script src="./assets/js/script.js"></script>
  <script src="./assets/js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const simulateBtn = document.getElementById('simulate-webhook');
      const checkBtn = document.getElementById('check-pending-orders');
      const resultsDiv = document.getElementById('test-results');
      const resultsContent = document.getElementById('results-content');

      simulateBtn?.addEventListener('click', async function() {
        const orderId = document.getElementById('webhook-order-id').value.trim();

        if (!orderId) {
          showResult('Please enter an order ID', 'error');
          return;
        }

        try {
          simulateBtn.disabled = true;
          simulateBtn.innerHTML = '<span class="text text-1">Processing...</span><span class="text text-2" aria-hidden="true">Processing...</span>';

          // Simulate a PayPal webhook by calling the webhook endpoint
          const response = await fetch(`/api/webhooks/paypal`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: orderId,
              status: 'COMPLETED',
              purchase_units: [{
                amount: {
                  currency_code: 'EUR',
                  value: '50.00'
                }
              }]
            })
          });

          const data = await response.text();

          if (response.ok) {
            showResult(`Payment processed successfully!\n\nOrder ID: ${orderId}\n\nResponse: ${data}`, 'success');
          } else {
            showResult(`Failed to process payment: ${data}`, 'error');
          }
        } catch (error) {
          showResult(`Error: ${error.message}`, 'error');
        } finally {
          simulateBtn.disabled = false;
          simulateBtn.innerHTML = '<span class="text text-1">Simulate Payment</span><span class="text text-2" aria-hidden="true">Simulate Payment</span>';
        }
      });

      checkBtn?.addEventListener('click', async function() {
        try {
          checkBtn.disabled = true;
          checkBtn.innerHTML = '<span class="text text-1">Checking...</span><span class="text text-2" aria-hidden="true">Checking...</span>';

          // Check pending orders
          const pendingResponse = await fetch('/api/admin/query?table=pending_orders&limit=10');
          const pendingOrders = await pendingResponse.json();

          // Check completed orders
          const ordersResponse = await fetch('/api/admin/query?table=orders&limit=10');
          const orders = await ordersResponse.json();

          const result = {
            pending_orders: pendingOrders,
            recent_orders: orders,
            timestamp: new Date().toISOString()
          };

          showResult(`Database Status Check:\n\n${JSON.stringify(result, null, 2)}`, 'info');
        } catch (error) {
          showResult(`Error: ${error.message}`, 'error');
        } finally {
          checkBtn.disabled = false;
          checkBtn.innerHTML = '<span class="text text-1">Check Pending Orders</span><span class="text text-2" aria-hidden="true">Check Pending Orders</span>';
        }
      });

      function showResult(message, type) {
        resultsDiv.style.display = 'block';

        let bgColor, textColor;
        switch (type) {
          case 'success':
            bgColor = 'var(--gold-crayola)';
            textColor = 'var(--smoky-black-1)';
            break;
          case 'error':
            bgColor = '#ef4444';
            textColor = 'white';
            break;
          case 'info':
          default:
            bgColor = 'var(--eerie-black-3)';
            textColor = 'var(--white)';
            break;
        }

        resultsDiv.style.background = bgColor;
        resultsDiv.style.color = textColor;
        resultsContent.textContent = message;
      }
    });
  </script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>
